#!/usr/bin/env bash

set -e

# –ü—Ä–æ–≤–µ—Ä–∫–∞, —á—Ç–æ –≤—Å–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∑–∞–¥–∞–Ω—ã
if [ -z "$1" ] || [ -z "$2" ] || [ -z "$3" ]; then
  echo "‚ùå –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: $0 DOMAIN OUTPUT_DIR DAYS"
  exit 1
fi

DOMAIN="$1"
OUTPUT_DIR="$2"
DAYS="$3"

# –§–∞–π–ª—ã –∫–ª—é—á–∞ –∏ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞
KEY_FILE="$OUTPUT_DIR/self-signed.key"
CRT_FILE="$OUTPUT_DIR/self-signed.crt"

echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞ –¥–ª—è –¥–æ–º–µ–Ω–∞ $DOMAIN ..."
if [ -f "$CRT_FILE" ]; then
  notAfter=$(openssl x509 -in "$CRT_FILE" -enddate -noout | cut -d= -f2-)
  expires=$(date -d "$notAfter" +%s)
  now=$(date +%s)

  if [ "$now" -lt "$expires" ]; then
    echo "‚úîÔ∏è –ù–∞–π–¥–µ–Ω –¥–µ–π—Å—Ç–≤—É—é—â–∏–π —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç, –∏—Å—Ç–µ–∫–∞–µ—Ç: $notAfter."
    echo "‚è≥ –ü–µ—Ä–µ–≤—ã–ø—É—Å–∫ –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è."
    exit 0
  else
    echo "‚ö†Ô∏è –°–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç –ø—Ä–æ—Å—Ä–æ—á–µ–Ω (–∏—Å—Ç—ë–∫: $notAfter), —Ç—Ä–µ–±—É–µ—Ç—Å—è –ø–µ—Ä–µ–≤—ã–ø—É—Å–∫."
  fi
else 
  echo "‚ÑπÔ∏è –°–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω. –ü—Ä–∏—Å—Ç—É–ø–∞–µ–º –∫ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –Ω–æ–≤–æ–≥–æ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞."
fi

echo "üîê –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –Ω–æ–≤–æ–≥–æ —Å–∞–º–æ–ø–æ–¥–ø–∏—Å–∞–Ω–Ω–æ–≥–æ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞ –¥–ª—è $DOMAIN –Ω–∞ $DAYS –¥–Ω–µ–π..."

openssl req -x509 -nodes -days "$DAYS" \
  -newkey rsa:2048 \
  -keyout "$KEY_FILE" \
  -out "$CRT_FILE" \
  -subj "/CN=${DOMAIN}/O=SelfSigned/C=US"

chmod 600 "$KEY_FILE"
chmod 600 "$CRT_FILE"

echo "‚úÖ –°–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç —É—Å–ø–µ—à–Ω–æ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω!"
echo "   üîë –ö–ª—é—á —Å–æ—Ö—Ä–∞–Ω—ë–Ω –≤: $KEY_FILE"
echo "   üìÑ –°–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç —Å–æ—Ö—Ä–∞–Ω—ë–Ω –≤: $CRT_FILE"