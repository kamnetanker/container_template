#!/usr/bin/env bash

set -e

CONFIG_DIR="/etc/nginx/sites-enabled"
MODULE_DIR="/opt/modules"

echo "üîß –ü—Ä–æ–≤–µ—Ä—è—é —É—Å—Ç–∞–Ω–æ–≤–∫—É –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö"
# –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã—Ö –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö
if [ -z "$LISTEN_ADDR" ]; then
    export LISTEN_ADDR="0.0.0.0"
    echo "‚ö†Ô∏è –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è LISTEN_ADDR –Ω–µ –±—ã–ª–∞ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞. –ù–∞–∑–Ω–∞—á–µ–Ω–æ –∑–Ω–∞—á–µ–Ω–∏–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: $LISTEN_ADDR"
else
    echo "‚úÖ –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è LISTEN_ADDR —É–∂–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞: $LISTEN_ADDR"
fi 

if [ -z "$HTTP_PORT" ]; then
    export HTTP_PORT=80
    echo "‚ö†Ô∏è –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è HTTP_PORT –Ω–µ –±—ã–ª–∞ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞. –ù–∞–∑–Ω–∞—á–µ–Ω–æ –∑–Ω–∞—á–µ–Ω–∏–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: $HTTP_PORT"
else
    echo "‚úÖ –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è HTTP_PORT —É–∂–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞: $HTTP_PORT"
fi 

if [ -z "$HTTPS_PORT" ]; then
    export HTTPS_PORT=443
    echo "‚ö†Ô∏è –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è HTTPS_PORT –Ω–µ –±—ã–ª–∞ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞. –ù–∞–∑–Ω–∞—á–µ–Ω–æ –∑–Ω–∞—á–µ–Ω–∏–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: $HTTPS_PORT"
else
    echo "‚úÖ –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è HTTPS_PORT —É–∂–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞: $HTTPS_PORT"
fi 
if [ -z "$CERT_DAYS" ]; then
    export CERT_DAYS=365
    echo "‚ö†Ô∏è –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è CERT_DAYS –Ω–µ –±—ã–ª–∞ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞. –ù–∞–∑–Ω–∞—á–µ–Ω–æ –∑–Ω–∞—á–µ–Ω–∏–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: $CERT_DAYS"
else
    echo "‚úÖ –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è CERT_DAYS —É–∂–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞: $CERT_DAYS"
fi 
if [ -z "$SSL_MODE" ]; then
    export SSL_MODE="no"
    echo "‚ö†Ô∏è –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è SSL_MODE –Ω–µ –±—ã–ª–∞ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞. –ù–∞–∑–Ω–∞—á–µ–Ω–æ –∑–Ω–∞—á–µ–Ω–∏–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: $SSL_MODE"
else
    echo "‚úÖ –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è SSL_MODE —É–∂–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞: $SSL_MODE"
fi 



echo "üîß –ó–∞–ø—É—Å–∫ –º–æ–¥—É–ª–µ–π –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏..." 
for module in "$MODULE_DIR"/*.sh; do
  echo "üì¶ –ó–∞–ø—É—Å–∫–∞—é –º–æ–¥—É–ª—å: $module"
  . "$module"
done

echo "‚úÖ –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –≥–æ—Ç–æ–≤–∞."

echo "‚úÖ –ó–∞–ø—É—Å–∫–∞–µ–º –¥–µ–º–æ–Ω cron –≤ —Ñ–æ–Ω–µ"
service cron start

echo "üì¶ –ó–∞–ø—É—Å–∫ Nginx"
nginx -t && nginx -g 'daemon off;'